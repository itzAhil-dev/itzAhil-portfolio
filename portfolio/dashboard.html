<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard | Itz Ahil</title>
<link rel="stylesheet" href="styles.css">
</head>
<body>
<header>
<h1>Admin Dashboard</h1>
<nav>
<a href="index.html">Home</a>
<a href="commissions.html">Commissions</a>
<a href="login.html" id="logoutBtn">Logout</a>
</nav>
</header>

<main>
<section class="dashboard">
<h2>Manage Projects & Commissions</h2>

<h3>Upload New Project</h3>
<form id="addProjectForm">
<input type="text" placeholder="Project Title" required>
<textarea placeholder="Project Description" required></textarea>
<input type="file" id="projectImage" required>
<button type="submit">Upload Project</button>
</form>

<h3>Commissions</h3>
<div class="table-container">
<table id="commissionsTable">
<thead>
<tr><th>User</th><th>Name</th><th>Email</th><th>Details</th><th>Budget</th></tr>
</thead>
<tbody></tbody>
</table>
</div>
</section>
</main>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

const SUPABASE_URL = "https://unwsgphexssgtdoycpbe.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVud3NncGhleHNzZ3Rkb3ljcGJlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg0MzIyOTcsImV4cCI6MjA3NDAwODI5N30.LHByPCS3lbMM0bAarfDDLJO_8AP2XhzmVflZ2QWqMag";
const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// Check admin user
(async () => {
  const { data: { user } } = await supabase.auth.getUser();
  if (!user || user.email !== "itzahil46@gmail.com") {
    alert("Unauthorized! Only admin can access this page.");
    window.location.href = "index.html";
  }
})();

// Logout button
document.getElementById("logoutBtn").addEventListener("click", async () => {
  await supabase.auth.signOut();
  window.location.href = "index.html";
});

// Load commissions
async function loadCommissions() {
  const { data, error } = await supabase.from("commissions").select("*");
  if (error) {
    console.error(error);
    return;
  }
  const tbody = document.querySelector("#commissionsTable tbody");
  tbody.innerHTML = "";
  data.forEach(c => {
    tbody.innerHTML += `<tr>
      <td>${c.user_id}</td>
      <td>${c.name}</td>
      <td>${c.email}</td>
      <td>${c.details}</td>
      <td>$${c.budget}</td>
    </tr>`;
  });
}
loadCommissions();

// Handle project upload
document.getElementById("addProjectForm").addEventListener("submit", async (e) => {
  e.preventDefault();
  const form = e.target;
  const title = form[0].value;
  const description = form[1].value;
  const file = document.getElementById("projectImage").files[0];

  if (!file) return alert("Please select an image.");

  // Upload file to Supabase Storage
  const { data: uploadData, error: uploadError } = await supabase.storage
    .from("projects")
    .upload(`images/${Date.now()}_${file.name}`, file);

  if (uploadError) return alert("Upload failed: " + uploadError.message);

  const imageUrl = `${SUPABASE_URL}/storage/v1/object/public/projects/${uploadData.path}`;

  // Insert project into database
  const { error: insertError } = await supabase.from("projects").insert([
    { title, description, image_url: imageUrl }
  ]);

  if (insertError) return alert("Database insert failed: " + insertError.message);

  alert("Project uploaded successfully!");
  form.reset();
});
</script>
</body>
</html>
